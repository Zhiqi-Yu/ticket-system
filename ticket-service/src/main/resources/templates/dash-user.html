<!doctype html>
<html><head><meta charset="UTF-8"><title>User</title></head>
<body>
<h3>User Dashboard</h3>
<a href="/logout">Logout</a><hr>

<h4>Create Ticket</h4>
<label>Title <input id="title" value="Demo Ticket"></label>
<label>Description <input id="desc" value="just a test"></label>
<label>Priority
    <select id="prio"><option>LOW</option><option selected>MEDIUM</option><option>HIGH</option></select>
</label>
<label>Category <input id="cat" value="IT"></label>
<button id="btnCreate">Create</button>

<hr>
<h4>Attachment</h4>
<label>Ticket ID <input id="tid" placeholder="id"></label>
<input type="file" id="file">
<button id="btnUpload">Upload</button>
<button id="btnDownload">Download</button>

<hr>
<h4>Operate</h4>
<button id="btnGet">Get</button>
<button id="btnClose">Close</button>
<button id="btnReopen">Reopen</button>
<button id="btnMy">My Tickets</button>
<button id="btnHistory">History</button>

<pre id="out" style="background:#f5f5f5;padding:8px"></pre>

<script>
    const out = document.getElementById('out'), tid = document.getElementById('tid');
    tid.value = localStorage.lastTicketId || '';
    function show(x){ out.textContent = JSON.stringify(x,null,2); if(x && x.id){ tid.value=x.id; localStorage.lastTicketId=x.id; } }
    async function api(p,m='GET',b){
        const r = await fetch(p,{method:m,headers:{'Content-Type':'application/json'},body:b?JSON.stringify(b):undefined});
        if(!r.ok){ show({error:r.status,text:await r.text()}); throw 0;} return r.json();
    }

    btnCreate.onclick = async ()=>{
        const data = {title:title.value, description:desc.value, priority:prio.value, category:cat.value};
        show(await api('/api/tickets','POST',data));
    };
    btnUpload.onclick = async ()=>{
        if(!tid.value){ show({error:'no ticket id'}); return; }
        const f = document.getElementById('file').files[0]; if(!f){ show({error:'choose a file'}); return; }
        const fd = new FormData(); fd.append('file', f);
        const r = await fetch(`/api/tickets/${tid.value}/attachment`, { method:'POST', body:fd });
        if(!r.ok){ show({error:r.status,text:await r.text()}); return; } show(await r.json());
    };
    btnDownload.onclick = ()=> window.location = `/api/tickets/${tid.value}/attachment`;
    btnGet.onclick = async ()=> show(await api(`/api/tickets/${tid.value}`));
    btnClose.onclick = async ()=> show(await api(`/api/tickets/${tid.value}/close` ,'POST',{comments:'ok'}));
    btnReopen.onclick= async ()=> show(await api(`/api/tickets/${tid.value}/reopen`,'POST',{comments:'need more work'}));
    btnMy.onclick    = async ()=> show(await api('/api/tickets'));
    btnHistory.onclick=async ()=> show(await api(`/api/tickets/${tid.value}/history`));
</script>
</body></html>
